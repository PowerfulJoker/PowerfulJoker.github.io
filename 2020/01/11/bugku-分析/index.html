<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="bugku 分析"><meta name="keywords" content="分析"><meta name="author" content="某獠,undefined"><meta name="copyright" content="某獠"><title>bugku 分析【Joker】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#flag被盗"><span class="toc-number">1.</span> <span class="toc-text">flag被盗</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#中国菜刀"><span class="toc-number">2.</span> <span class="toc-text">中国菜刀</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#这么多数据包"><span class="toc-number">3.</span> <span class="toc-text">这么多数据包</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#手机热点"><span class="toc-number">4.</span> <span class="toc-text">手机热点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#抓到一只苍蝇"><span class="toc-number">5.</span> <span class="toc-text">抓到一只苍蝇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#日志审计"><span class="toc-number">6.</span> <span class="toc-text">日志审计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#weblogic"><span class="toc-number">7.</span> <span class="toc-text">weblogic</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#信息提取"><span class="toc-number">8.</span> <span class="toc-text">信息提取</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#特殊后门"><span class="toc-number">9.</span> <span class="toc-text">特殊后门</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">某獠</div><div class="author-info-description">Keep up!</div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/PowerfulJoker/PowerfulJoker.github.io" target="_blank">GitHub<i class="icon-dot bg-color2"></i></a><a class="links-button button-hover" href="mailto:741218399@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color1"></i></a><a class="links-button button-hover" href="tencent://message/?uin=741218399&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color5"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">9</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">7</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">3</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="title-name" href="/">Joker</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">bugku 分析</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-01-11 | 更新于 2020-02-24</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/Web/">Web</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/%E5%88%86%E6%9E%90/">分析</a></div></div></div><div class="main-content"><p>最近刷了一下bugku中关于分析的题目，其中有几道还是比较有意思的，写下博客来巩固一下。</p>
<h1 id="flag被盗"><a href="#flag被盗" class="headerlink" title="flag被盗"></a>flag被盗</h1><p>在分组字节流中搜索字符串flag，发现一个flag.txt</p>
<p><img src="/images/a601.png" alt="search"><br>追踪http流，发现flag</p>
<p><img src="/images/a602.png" alt="http_stream"></p>
<h1 id="中国菜刀"><a href="#中国菜刀" class="headerlink" title="中国菜刀"></a>中国菜刀</h1><p>看到中国菜刀，第一反应便是一句话木马，在分组字节流中搜索eval关键词，发现一句话木马，并且发现可疑文件3.php</p>
<p><img src="/images/a603.png" alt="ma"><br>然后再查看通过3.php进行哪些操作，最后在数据包后面追踪http数据流发现3.php获取了一个flag.tar.gz的文件</p>
<p><img src="/images/a604.png" alt="3php"></p>
<p><img src="/images/getflag.png" alt="getflag"><br>对http流中的$xx(后字符串进行URL解码然后进行base64解码，得到以下内容</p>
<pre><code>@ini_set(&quot;display_errors&quot;,&quot;0&quot;); 
@set_time_limit(0);    if(PHP_VERSION&lt;&apos;5.3.0&apos;{@set_magic_quotes_runtime(0);};echo(&quot;X@Y&quot;);
$F=&quot;C:\\wwwroot\\flag.tar.gz&quot;;
$fp=@fopen($F,&apos;r&apos;)
if(@fgetc($fp{@fclose($fp);@readfile($F);}
else{echo(&apos;ERROR:// Can Not Read&apos;);};
echo(&quot;X@Y&quot;);
die();</code></pre><p>导出第32数据包的http对象,保存为后缀名为.tar.gz的文件</p>
<p><img src="/images/a605.png" alt="http_obj"></p>
<p><img src="/images/a606.png" alt="32obj"><br>解压得到flag.txt</p>
<p><img src="/images/a607.png" alt="getfinalflag"></p>
<h1 id="这么多数据包"><a href="#这么多数据包" class="headerlink" title="这么多数据包"></a>这么多数据包</h1><p>我们使用wireshark打开该文件，可以看到数据包非常多，先使用字符串对分组列表和分组数据流查找flag关键字，并没有啥发现，浏览一下数据，可以看出ip地址为192.168.116.138的主机在对ip地址为192.168.116.159的主机发送大量数据包进行端口探测，猜测ip地址为192.168.116.138的主机为攻击机。<br><img src="/images/a608.png" alt="search_port"><br>有题目可知攻击机拿到了主机的shell权限，将过滤器设置为ip.addr=192.168.116.139，然后一直往下翻，在一片红色结束后的地方，发现ip地址为192.168.116.139主机的4444端口在不断的向192.168.116.159的主机发送数据包，然后对其进行追踪tcp流，然后导出其中的数据包进行查找flag，都没有发现flag。<br><br>再继续往下翻,忽略4444端口&lt;–&gt;1040端口通信的数据包，然后发现35880端口与1040端口通信的数据包，进行追踪tcp流，发现这是getshell的流，并发现一串攻击机从被攻击主机中查看的的s4cr4t.txt文件中的一段base64编码字符串。</p>
<p><img src="/images/a609.png" alt="getshell"></p>
<p><img src="/images/a610.png" alt="base64"><br>对base64编码的字符串进行解码即可得到flag</p>
<p><img src="/images/a611.png" alt="getflag"></p>
<h1 id="手机热点"><a href="#手机热点" class="headerlink" title="手机热点"></a>手机热点</h1><p>Ctrl+f在分组字节流查找flag关键字，发现flag.gif与secret.rar</p>
<p><img src="/images/a612.png" alt="secret"><br>导出该分组，并使用foremost对其进行分离，得到以下文件：</p>
<p><img src="/images/a613.png" alt="documents"><br>对rar文件夹中的rar文件进行解压，得到flag.gif</p>
<p><img src="/images/a614.png" alt="getflag"></p>
<h1 id="抓到一只苍蝇"><a href="#抓到一只苍蝇" class="headerlink" title="抓到一只苍蝇"></a>抓到一只苍蝇</h1><p>根据题目提示，搜索分组列表和分组字节流中的字符串fly，找到以下结果：</p>
<p><img src="/images/a615.png" alt="15"></p>
<p><img src="/images/a616.png" alt="16"></p>
<p><img src="/images/a617.png" alt="17"><br>由图可知，在进行邮件传输，且文件名为fly.rar。<br><br>将过滤器设置为只查看POST传输的模式，查看传输内容，</p>
<p><img src="/images/a618.png" alt="18"><br>发现ip为192.168.1.101的主机向ip地址为59.37.116.102的主机发送的几个数据包中数据均是相同的开头，并可以猜测这几个数据包是基于同一种协议分段发送的文件。且前四个数据包大小相同均为131436bytes，最后一个大小为1777bytes，总大小为131436 x 4 + 1777 = 527521，图一的文件fly.rar大小为525701，两者大小相似，可以猜测这5个数据包传输的文件即为fly.rar</p>
<p><img src="/images/a619.png" alt="19"></p>
<p><img src="/images/a620.png" alt="20"><br>使用导出对象中的http，对照分组编号，将这5个文件的数据包提取出来，并按顺序命名，</p>
<p><img src="/images/a621.png" alt="21"></p>
<p><img src="/images/a622.png" alt="22"><br>使用二进制编辑器查看001文件(我使用的是010 Editor)，找出文件数据前的协议头内容</p>
<p><img src="/images/a623.png" alt="23"><br>然后有两种方法将这几个数据包的数据组装回fly.rar文件，第一种方法是新建二进制文件，将这五个文件协议头内容后面的内容依次复制到新建的二进制文件种，然后保存为rar格式文件，第二种方法是将这五个文件的前面的协议头内容去除，然后使用cmd的命令将其合成 copy /B 001+002+003+004+005 flag.rar。<br>然后对其进行解压，发现警告，文件头损坏，并且需要输入密码，</p>
<p><img src="/images/a624.png" alt="24"><br>使用二进制编辑器010 Editor进行查看，发现是rar文件的文件块部分(rar文件由几个文件块组成，文件块为其中一个块)的头标记为加密标记</p>
<p><img src="/images/a625.png" alt="25"><br>0x74是块类型的标志，代表这个块是文件块，后面是0x84的4表示进行了加密，将其修改为0，便可以成功解压文件(对rar文件格式不进行过多讲解，可自行百度)。<br>解压之后，发现是个txt文件，但打开后发现这是个windows系统下的一个程序 </p>
<p><img src="/images/a626.png" alt="26"><br>将文件后缀名更改为exe，并运行，然后你的电脑屏幕就出现了五只苍蝇。。。。。。<br><br>对文件搜索flag使用strings命令搜索，看是否存在隐藏信息，发现并没有。然后使用binwalk对软件进行分析，发现一堆png文件，使用foremost对文件进行分离，在一堆苍蝇图中发现一个二维码</p>
<p><img src="/images/a627.png" alt="27"><br>扫描该二维码即可得到flag</p>
<p><img src="/images/a628.png" alt="28"><br>（这题关键在于找出传输的文件，对rar文件的了解，以及对文件进行分析。）</p>
<h1 id="日志审计"><a href="#日志审计" class="headerlink" title="日志审计"></a>日志审计</h1><p>这题的知识点主要在于基于布尔型的sql盲注，对请求头进行url解码，然后获得爆出的flag的字符的ascii值，再转成字符就行了</p>
<p><img src="/images/a629.png" alt="picture"><br>判断flag某个字符的ascii的值的方法为：看在测试该字符的最后一次ascii的值，若是该值的返回为200，则该字符值为这最后一次的ascii值+1；若返回值为404，则该字符的ascii值即为这最后一次的ascii值。<br><br>可人工得到的flag的ascii值: 102, 108, 97, 103, 123, 115, 112, 108, 109, 52, 112, 95, 49, 53, 95, 112, 48, 119, 101, 114, 102, 117, 108, 125<br>转成字符为: flag{splm4p_15_p0werful}<br>也可使用一下脚本来获取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">f = open(&apos;access.log&apos;, &apos;r&apos;)</span><br><span class="line">flag = &#123;&#125;</span><br><span class="line">for line in f.readlines():</span><br><span class="line">    st = re.search(r&apos;LIMIT 0,1\),(\d*?),1\)\)&gt;(\d*?) AND \&apos;RCKM\&apos;\=\&apos;RCKM&amp;Submit\=Submit HTTP/1.1\&quot; (\d*?) &apos;, line)</span><br><span class="line">    if st:</span><br><span class="line">        x = int(st.group(1))</span><br><span class="line">        y = int(st.group(2))</span><br><span class="line">        z = int(st.group(3))</span><br><span class="line">        if z == 200:</span><br><span class="line">            v = y + 1</span><br><span class="line">        else:</span><br><span class="line">            v = y</span><br><span class="line">        flag[x] = int(v)</span><br><span class="line">f.close()</span><br><span class="line">rs = &apos;&apos;</span><br><span class="line">for fl in flag.values():</span><br><span class="line">    rs = rs + chr(fl)</span><br><span class="line">print(rs)</span><br></pre></td></tr></table></figure>
<p>运行结果为：</p>
<p><img src="/images/script1.png" alt="script"></p>
<h1 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h1><p>根据题目提示在分组字节流中搜索字符串hostname，找到数据包</p>
<p><img src="/images/a630.png" alt="hostname"><br>追踪http流，并在http流中搜索hostname即可得到主机名，即flag:</p>
<p><img src="/images/a631.png" alt="gettheflag"></p>
<h1 id="信息提取"><a href="#信息提取" class="headerlink" title="信息提取"></a>信息提取</h1><p>这题与日志审计的题类似，知识点都是基于布尔型的sql盲注,将过滤器设置为http or http2，不同点在于这题在进行盲注时，若是条件为假，依然返回200，但追踪http流可发现，条件为真与返回的数据包与条件为假时返回的数据包不同，当条件为真时，数据包长度为460左右；当条件为假时，数据包长度为430左右，所以可以选择一个合适的长度来进行判断字符的ascii值。</p>
<p><img src="/images/a632.png" alt="http"><br>然后导出分组解析结果为CSV文件</p>
<p><img src="/images/a633.png" alt="csv"><br>然后使用notepad++打开，并进行URL解码，然后接下来的步骤便与“日志审计”一题类似，可手工，也可写脚本进行处理。处理脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">f = open(<span class="string">'save.csv'</span>, <span class="string">'r'</span>)</span><br><span class="line">x = <span class="number">0</span></span><br><span class="line">y = <span class="number">0</span></span><br><span class="line">z = <span class="number">0</span></span><br><span class="line">flag = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">    st = re.search(<span class="string">r'LIMIT 0,1\),(\d*?),1\)\)&gt;(\d*?) HTTP/1\.1'</span>, line)</span><br><span class="line">    st2 = re.search(<span class="string">r'\"(\d*?)\",\"HTTP/1.1'</span>, line)</span><br><span class="line">    <span class="keyword">if</span> st:</span><br><span class="line">        x = int(st.group(<span class="number">1</span>))</span><br><span class="line">        y = int(st.group(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">if</span> st2:</span><br><span class="line">        z = int(st2.group(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> z &gt; <span class="number">450</span>:</span><br><span class="line">            v = y+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v = y</span><br><span class="line">        flag[x] = v</span><br><span class="line">f.close()</span><br><span class="line">rs = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> fl <span class="keyword">in</span> flag.values():</span><br><span class="line">    rs = rs + chr(fl)</span><br><span class="line">print(rs)</span><br></pre></td></tr></table></figure>
<p>运行结果为：<br><img src="/images/script2.png" alt="script"></p>
<h1 id="特殊后门"><a href="#特殊后门" class="headerlink" title="特殊后门"></a>特殊后门</h1><p>在分组字节流中搜索字符串flag,找到icmp数据包</p>
<p><img src="/images/a635.png" alt="icmp"><br>然后查看后面这些异常的icmp数据包，发现flag被分割成一个个字符隐藏在其中</p>
<p><img src="/images/a636.png" alt="getflag"></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">某獠</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://powerfuljoker.github.io/2020/01/11/bugku-%E5%88%86%E6%9E%90/">https://powerfuljoker.github.io/2020/01/11/bugku-%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://powerfuljoker.github.io">Joker</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2020/02/20/Python%E5%85%A5%E9%97%A8-%E2%80%94-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-1/"><i class="fas fa-angle-left">&nbsp;</i><span>Python入门 — 基本数据类型(1)</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2019/11/23/%E8%89%B2%E5%BD%A9%E5%B9%B3%E8%A1%A1%E4%B8%8E%E8%9E%8D%E5%90%88%E7%94%A8%E4%BA%8E%E6%B0%B4%E4%B8%8B%E5%9B%BE%E5%83%8F%E5%A2%9E%E5%BC%BA-matlab%E5%AE%9E%E7%8E%B0/"><span>色彩平衡与融合用于水下图像增强(matlab实现)</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2020 By 某獠</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--></body></html>